---
title: "Check Network Metrics"
author: "M. Fisher"
date: "Written Oct 1, 2021. Last Run `r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
  pdf_document:
    highlight: haddock
    number_sections: yes
    toc: yes
    toc_depth: '3'
geometry: margin=1in
subtitle: Preparation for network analysis in CCIEA ESR
fontsize: 11pt
---

# Description

As of Aug 17, the `calc_network_stats.R` script is outputting some weird network metric values. Specifically: 

1. There are gaps in centralization based on connectivity edges at FB and MB

2. Edge density is always one in the connectivity edges networks


```{r setup, include=FALSE}
if(!require("here")) {install.packages("here")}
library(here)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())

## start time for full script
script_start_time <- Sys.time()
```
<br>

This script requires the following packages:
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(igraph)
```
<br>


# Edge Density

## Port Group Networks

Connectivity network edges, no revenue filtering. (file:`NetworkStats_2004_2019_21pcgroups_totalrev1_indivrev1_connectivity_rmCrab_10pContribution.csv`)
```{r include=FALSE}
# file with incorrect metrics
mystats <- read.csv(here::here('results','statistics','NetworkStats_2004_2019_21pcgroups_totalrev1_indivrev1_connectivity_rmCrab_10pContribution.csv'))
```
```{r echo=FALSE}
ggplot(data=filter(mystats, pcgroup %in% c("North WA Coast", "Astoria","Fort Bragg","Morro Bay")), aes(x=y, y=ed)) + 
  geom_point() + geom_line() +
  facet_grid(cols=vars(pcgroup), scales="free_y") +
  scale_x_continuous(breaks=seq(min(mystats$y), max(mystats$y), by=2), labels=seq(min(mystats$y), max(mystats$y), by=2)) +
  ylim(c(0,1)) +
  ylab("Edge Density") + xlab("Year") +
  theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
                     axis.title.x=element_text(size=13),
                     axis.title.y=element_text(size=13),
                     strip.text=element_text(size=13),
                     legend.title=element_text(size=13),legend.text=element_text(size=13),
                     panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
```



Connectivity network edges, total revenue filtering. (file:`NetworkStats_2004_2019_21pcgroups_totalrev5000_indivrev1_connectivity_rmCrab_10pContribution.csv`)
```{r include=FALSE}
# file with incorrect metrics
mystats2 <- read.csv(here::here('results','statistics','NetworkStats_2004_2019_21pcgroups_totalrev5000_indivrev1_connectivity_rmCrab_10pContribution.csv'))
```
```{r echo=FALSE}
ggplot(data=filter(mystats2, pcgroup %in% c("North WA Coast", "Astoria","Fort Bragg","Morro Bay")), aes(x=y, y=ed)) + 
  geom_point() + geom_line() +
  facet_grid(cols=vars(pcgroup), scales="free_y") +
  scale_x_continuous(breaks=seq(min(mystats2$y), max(mystats2$y), by=2), labels=seq(min(mystats2$y), max(mystats2$y), by=2)) +
  ylim(c(0,1)) +
  ylab("Edge Density") + xlab("Year") +
  theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
                     axis.title.x=element_text(size=13),
                     axis.title.y=element_text(size=13),
                     strip.text=element_text(size=13),
                     legend.title=element_text(size=13),legend.text=element_text(size=13),
                     panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
```



Connectivity network edges, total and individual revenue filtering. (file:`NetworkStats_2004_2019_21pcgroups_totalrev5000_indivrev500_connectivity_rmCrab_10pContribution.csv`)
```{r include=FALSE}
# file with incorrect metrics
mystats3 <- read.csv(here::here('results','statistics','NetworkStats_2004_2019_21pcgroups_totalrev5000_indivrev500_connectivity_rmCrab_10pContribution.csv'))
```
```{r echo=FALSE}
ggplot(data=filter(mystats3, pcgroup %in% c("North WA Coast", "Astoria","Fort Bragg","Morro Bay")), aes(x=y, y=ed)) + 
  geom_point() + geom_line() +
  facet_grid(cols=vars(pcgroup), scales="free_y") +
  scale_x_continuous(breaks=seq(min(mystats3$y), max(mystats3$y), by=2), labels=seq(min(mystats3$y), max(mystats3$y), by=2)) +
  ylim(c(0,1)) +
  ylab("Edge Density") + xlab("Year") +
  theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
                     axis.title.x=element_text(size=13),
                     axis.title.y=element_text(size=13),
                     strip.text=element_text(size=13),
                     legend.title=element_text(size=13),legend.text=element_text(size=13),
                     panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
```


**The problem only occurs when the port group - level networks include an additional filtering step: the minimum revenue (in dollars) generated from any one fishery for a given vessel in a given year must be > $500**
```{r include=FALSE}
stats1 <- mystats3
```
<br>



## State Networks

Connectivity network edges, no revenue filtering.  (file:`NetworkStats_2004_2019_3states_totalrev1_indivrev1_connectivity_rmCrab_10pContribution.csv`)
```{r include=FALSE}
# file with incorrect metrics
mystats <- read.csv(here::here('results','statistics','NetworkStats_2004_2019_3states_totalrev1_indivrev1_connectivity_rmCrab_10pContribution.csv'))
```
```{r echo=FALSE}
ggplot(data=mystats, aes(x=y, y=ed)) + 
  geom_point() + geom_line() +
  facet_grid(cols=vars(state), scales="free_y") +
  scale_x_continuous(breaks=seq(min(mystats$y), max(mystats$y), by=2), labels=seq(min(mystats$y), max(mystats$y), by=2)) +
  ylim(c(0,1)) +
  ylab("Edge Density") + xlab("Year") +
  theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
                     axis.title.x=element_text(size=13),
                     axis.title.y=element_text(size=13),
                     strip.text=element_text(size=13),
                     legend.title=element_text(size=13),legend.text=element_text(size=13),
                     panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
```



Connectivity network edges, total revenue filtering. (file:`NetworkStats_2004_2019_3states_totalrev5000_indivrev1_connectivity_rmCrab_10pContribution.csv`)
```{r include=FALSE}
# file with incorrect metrics
mystats2 <- read.csv(here::here('results','statistics','NetworkStats_2004_2019_3states_totalrev5000_indivrev1_connectivity_rmCrab_10pContribution.csv'))
```
```{r echo=FALSE}
ggplot(data=mystats2, aes(x=y, y=ed)) + 
  geom_point() + geom_line() +
  facet_grid(cols=vars(state), scales="free_y") +
  scale_x_continuous(breaks=seq(min(mystats2$y), max(mystats2$y), by=2), labels=seq(min(mystats2$y), max(mystats2$y), by=2)) +
  ylim(c(0,1)) +
  ylab("Edge Density") + xlab("Year") +
  theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
                     axis.title.x=element_text(size=13),
                     axis.title.y=element_text(size=13),
                     strip.text=element_text(size=13),
                     legend.title=element_text(size=13),legend.text=element_text(size=13),
                     panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
```


 
Connectivity network edges, total and individual revenue filtering.  (file:`NetworkStats_2004_2019_3states_totalrev5000_indivrev500_connectivity_rmCrab_10pContribution.csv`)
```{r include=FALSE}
# file with incorrect metrics
mystats3 <- read.csv(here::here('results','statistics','NetworkStats_2004_2019_3states_totalrev5000_indivrev500_connectivity_rmCrab_10pContribution.csv'))
```
```{r echo=FALSE}
ggplot(data=mystats3, aes(x=y, y=ed)) + 
  geom_point() + geom_line() +
  facet_grid(cols=vars(state), scales="free_y") +
  scale_x_continuous(breaks=seq(min(mystats3$y), max(mystats3$y), by=2), labels=seq(min(mystats3$y), max(mystats3$y), by=2)) +
  ylim(c(0,1)) +
  ylab("Edge Density") + xlab("Year") +
  theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
                     axis.title.x=element_text(size=13),
                     axis.title.y=element_text(size=13),
                     strip.text=element_text(size=13),
                     legend.title=element_text(size=13),legend.text=element_text(size=13),
                     panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
```


**Again, the problem only occurs when the state - level networks include an additional filtering step: the minimum revenue (in dollars) generated from any one fishery for a given vessel in a given year must be > $500**
```{r include=FALSE}
stats2 <- mystats3
```
<br>


## Troubleshooting

### Issue Opt 1: calculating edge density

Working backward -- first possible problem is that something is going wrong in the calculation of edge density in the R file (not sure why this would be happening for only one set of networks though). Let's check if the igraph object reflects an edge density of 1. 

For now, I'll use North WA Coast as a case study.  (file:`NetworkStats_2004_2019_21pcgroups_totalrev5000_indivrev500_connectivity_rmCrab_10pContribution.csv`)

```{r}
stats1 %>% filter(pcgroup=="North WA Coast") %>% filter(y > 2005 & y < 2010) %>% dplyr::select(pcgroup,y,N,E,ed)
```
<br>

```{r}
g <- readRDS(here::here('data','networks','participation_vessel_ports','igraph_North WA Coast_2007_totalrev5000_indivrev500_connectivity_rmCrab.rds'))
g
```

![](https://raw.githubusercontent.com/jameals/cciea_networks/main/data/networks/participation_vessel_ports/plots/North%20WA%20Coast_2007_circular_cciea.png)



What is the ratio of the number of edges (`ecount` function), and the number of possible edges (`(N-1)((N-1)+1)/2`)? 
```{r echo=FALSE}
paste0("edges: ", ecount(g))
N=vcount(g); pe=((N-1) * ((N-1)+1))/2
paste0("possible edges: ", pe)
paste0("manually calculated edge density: ", ecount(g) / pe)
```

What is the edge density that igraph calculates? 
```{r}
edge_density(g)
```

Neither are returning an edge density of 1. 

what's also very weird is that the "N" (node count) and "E" (edge count) in the stats file are also incorrect; true node count is `r vcount(g)` and true edge count is `r ecount(g)`.

Load the function and run it on our graph `g`: 
```{r}
source(here::here('R','calc_network_stats.r'))
source(here::here('R','network_stats_functions.r'))
net_stats(g,y=2007,stats="network")
```
<br>

The `calc_network_stats.R` script seems to be working fine.


### Issue Opt 2: saving edge density

The second possible problem is that the output from the `calc_network_stats.R` script is somehow being saved incorrectly in the Rmd that generates the different networks and their stats.


Let's re-run section *1) B)(ii) and C)(i) A minimum annual total fisheries revenue cutoff for each vessel of 5,000, and a minimum annual individual fisheries revenue cutoff for each vessel of 500.* from the `06_create_networks_4ways.Rmd` script.


```{r}
total_rev_cutoff <- 5000
indiv_rev_cutoff <- 500
edgetype <- "connectivity"
rm_crab=TRUE
outdir_ports = 'data/networks/participation_vessel_ports'
```
<br>

Check stats for one year
```{r eval=TRUE}
y=2007
iopac = "North WA Coast"
wc_state = "W"

      rds_name <- ifelse(rm_crab,  paste0("igraph_", iopac, "_", y, "_totalrev", total_rev_cutoff,"_indivrev", indiv_rev_cutoff,"_", edgetype,"_rmCrab.rds"),  paste0("igraph_", iopac, "_", y, "_", total_rev_cutoff,"_", indiv_rev_cutoff,"_", edgetype,".rds")) # updated to iopac 03-10-21, was "igraph_", p
      print(rds_name)
      tmp_g <- readRDS(here::here(outdir_ports, rds_name))
      
    # Calculate network-level statistics
    ## using the `net_stats` function
    g_stats <- net_stats(tmp_g, y = y, stats="network")
    #g_stats <- net_stats(tmp_g, y = 2008, stats="network")
    ## add on period (closure/open) and port group info
    g_stats <- g_stats %>%
      #mutate(period = rep("early", times=dim(g_stats)[1])) %>%
      mutate(pcgroup = rep(iopac, times=dim(g_stats)[1])) # updated to iopac 03-10-21, was rep(p
g_stats %>% dplyr::select(pcgroup,y,N,E,ed)
```
<br>


Check stats over all years
```{r}
## (crab) years
years <- seq(2004,2019)

## IOPAC port groups
myports <- c("Puget Sound","North WA Coast","WA Coast","Other Coastal Washington","Astoria","Tillamook","Columbia River","Newport","Coos Bay","Brookings","Crescent City","Eureka","Morro Bay","Fort Bragg","Bodega Bay","San Francisco","San Diego","Monterey","Santa Barbara","Los Angeles","Unknown Ports" )

```
```{r}
for(y in years){
  for(iopac in myports){ # updated to iopac 03-10-21, was p
    cat(iopac, "\n")
    
    ### pull fish ticket data for given year, port group ###
    
    
    ##### Create igraph object ####
     rds_name <- ifelse(rm_crab,  paste0("igraph_", iopac, "_", y, "_totalrev", total_rev_cutoff,"_indivrev", indiv_rev_cutoff,"_", edgetype,"_rmCrab.rds"),  paste0("igraph_", iopac, "_", y, "_", total_rev_cutoff,"_", indiv_rev_cutoff,"_", edgetype,".rds")) # updated to iopac 03-10-21, was "igraph_", p
      
     if(file.exists(here::here(outdir_ports, rds_name))){
       tmp_g <- readRDS(here::here(outdir_ports, rds_name))
       
       # Calculate network-level statistics
       ## using the `net_stats` function
       g_stats <- net_stats(tmp_g, y = y, stats="network")
       #g_stats <- net_stats(tmp_g, y = 2008, stats="network")
       ## add on period (closure/open) and port group info
       g_stats <- g_stats %>%
         #mutate(period = rep("early", times=dim(g_stats)[1])) %>%
         mutate(pcgroup = rep(iopac, times=dim(g_stats)[1])) # updated to iopac 03-10-21, was rep(p
       
       #### SAVE NETWORK STATS OUTPUT ####
       ## merge network stats from closure / open period
       # if(length(V(tmp_g)$name) == 0){
       #   tmp_stats <- g_stats
       # } else{
       #   tmp_stats <- rbind(g_stats, late_stats)
       # }
       ## append to network stats output data frame
       if(exists("test_stats")){
         test_stats <- rbind(test_stats, g_stats)
       } else{
         test_stats <- g_stats
       }
     }
  } #end (p in myports)
  cat("\nfinished with all port groups in crab year ", y, "\n-----\n")
} #end (y in years)
```
<br>

Check the same rows of data as at the start of the section:
```{r}
test_stats %>% filter(pcgroup=="North WA Coast") %>% filter(y > 2005 & y < 2010) %>% dplyr::select(pcgroup,y,N,E,ed)
```
<br>

Plot the same timeseries as before:
```{r echo=FALSE}
ggplot(data=filter(test_stats, pcgroup %in% c("North WA Coast", "Astoria","Fort Bragg","Morro Bay")), aes(x=y, y=ed)) + 
  geom_point() + geom_line() +
  facet_grid(cols=vars(pcgroup), scales="free_y") +
  scale_x_continuous(breaks=seq(min(test_stats$y), max(test_stats$y), by=2), labels=seq(min(test_stats$y), max(test_stats$y), by=2)) +
  ylim(c(0,1)) +
  ylab("Edge Density") + xlab("Year") +
  theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
                     axis.title.x=element_text(size=13),
                     axis.title.y=element_text(size=13),
                     strip.text=element_text(size=13),
                     legend.title=element_text(size=13),legend.text=element_text(size=13),
                     panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
```
<br>

### Issue Opt 3: creating networks



<br>

# Network Centralization

Connectivity network edges, total and individual revenue filtering. (file name :`NetworkStats_2004_2019_21pcgroups_totalrev5000_indivrev500_connectivity_rmCrab_10pContribution.csv`)
```{r echo=FALSE}
ggplot(data=filter(stats1, pcgroup %in% c("North WA Coast", "Astoria","Fort Bragg","Morro Bay")), aes(x=y, y=nc_weighted)) + 
  geom_point() + geom_line() +
  facet_grid(cols=vars(pcgroup), scales="free_y") +
  scale_x_continuous(breaks=seq(min(stats1$y), max(stats1$y), by=2), labels=seq(min(stats1$y), max(stats1$y), by=2)) +
  ylim(c(0,1)) +
  ylab("Centralization") + xlab("Year") +
  theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
                     axis.title.x=element_text(size=13),
                     axis.title.y=element_text(size=13),
                     strip.text=element_text(size=13),
                     legend.title=element_text(size=13),legend.text=element_text(size=13),
                     panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
```

Centralization by network size (# of nodes):
```{r echo=FALSE, fig.height=3, fig.width=6}
ggplot(data=filter(stats1, pcgroup %in% c("North WA Coast", "Astoria","Fort Bragg","Morro Bay")), aes(x=N, y=nc_weighted, col=pcgroup)) + 
  geom_point() +
  ylim(c(0,1)) +
  ylab("Centralization") + xlab("Network Size") +
  theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
                     axis.title.x=element_text(size=13),
                     axis.title.y=element_text(size=13),
                     strip.text=element_text(size=13),
                     legend.title=element_text(size=13),legend.text=element_text(size=13),
                     panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
```
<br>



With the newly generated stats data-frame from the **Edge Density** section:
```{r echo=FALSE}
ggplot(data=filter(test_stats, pcgroup %in% c("North WA Coast", "Astoria","Fort Bragg","Morro Bay")), aes(x=y, y=nc_weighted)) + 
  geom_point() + geom_line() +
  facet_grid(cols=vars(pcgroup), scales="free_y") +
  scale_x_continuous(breaks=seq(min(test_stats$y), max(test_stats$y), by=2), labels=seq(min(test_stats$y), max(test_stats$y), by=2)) +
  ylim(c(0,1)) +
  ylab("Centralization") + xlab("Year") +
  theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
                     axis.title.x=element_text(size=13),
                     axis.title.y=element_text(size=13),
                     strip.text=element_text(size=13),
                     legend.title=element_text(size=13),legend.text=element_text(size=13),
                     panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
```
<br>


Same as in **Edge Density** section, I'm unable to replicate the issue...