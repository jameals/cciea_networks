---
title: "Summarize WDFW fish tickets isportderived"
author: "Jameal Samhouri"
date: "Written 2025-02-04 Last Run `r Sys.Date()`"
output: 
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '5'
  pdf_document:
    highlight: haddock
    number_sections: yes
    toc: yes
    toc_depth: '3'
geometry: margin=1in
fontsize: 11pt
---

# PacFIN query

Make sure to update the definition of `latestpull` with the date on which PacFIN was queried, and `min_crab_year` and `max_crab_year` to define the years reported for the ESR.

<!-- SELECT * -->

<!--     FROM PACFIN_MARTS.COMPREHENSIVE_FT cft -->

<!--          LEFT JOIN PACFIN_MARTS.WDFW_FT_PORT_DERIVED_V ftpd -->

<!--              ON     cft.pacfin_year = ftpd.landing_year -->

<!--                 AND cft.ftid = ftpd.ftid -->

<!--                 AND cft.agency_code = ftpd.agency_code -->

<!--    WHERE cft.pacfin_year BETWEEN 2003 AND 2025 AND cft.agency_code = 'W' -->

<!-- ORDER BY cft.landing_year DESC; -->

# Load libraries and set directories
```{r setup}

if(!require("here")) {install.packages("here")}
if(!require("tidyverse")) {install.packages("tidyverse")}
if(!require("lubridate")) {install.packages("lubridate")}
if(!require("formattable")) {install.packages("formattable")}
if(!require("kableExtra")) {install.packages("kableExtra")}
if(!require("scales")) {install.packages("scales")}
if(!require("dplyr")) {install.packages("dplyr")}
if(!require("tictoc")) {install.packages("tictoc")}

library(here)
library(tidyverse)
library(lubridate)
library(formattable)
library(kableExtra)
library(dplyr)
library(scales)
library(tictoc)

# raw PacFIN fish ticket data file location
indir2 <- "/Users/jameal.samhouri/Documents/CONFIDENTIAL DATA/PacFIN Tickets/"

# output directory for confidential data
out_conf_dir <- "/Users/jameal.samhouri/Documents/CONFIDENTIAL DATA/PacFIN Tickets/"

statdir = 'results/statistics'

```

# Read in csv or rds

If you have a new download of fish ticket data and want to clean it up a bit and convert it to RDS, use this chunk.


<!-- ```{r csv2rds} -->

<!-- # NOTE: reading in PacFIN csv's for multiple years is SLOW, and took >1.5hrs on JS macbook -->
<!-- tic() -->

<!-- tmpfile_name <- 'fish tickets 2003-2025 WDFW  port derived 012725.csv' # latest pull from PacFIN 01-27-2026 -->
<!-- tmpfile2 <- read.csv(paste0(indir2,tmpfile_name)) -->
<!-- #glimpse(tmpfile2) -->

<!-- #as.Date(tmpfile2[1,]$LANDING_DATE, "%m/%d/%Y") -->

<!-- # # LANDING_YEAR in more recent data pulls has a time associated with it. convert myfile2$LANDING_DATE to date formats that exclude time. added 12-29-2021 -->
<!-- # update 01-28-2026. LANDING_DATE format now is 21-SEP-25, so updated conversion below -->
<!-- tmpfile2$LANDING_DATE <- as.Date(tmpfile2$LANDING_DATE, "%d-%b-%y") -->
<!-- write_rds(tmpfile2, paste0(out_conf_dir,'WDFW fish tickets 2003-2025_',Sys.Date(),'.rds')) -->
<!-- rm(tmpfile2) -->

<!-- toc() -->
<!-- # 86.833 sec elapsed -->
<!-- ``` -->


If you already have an rds, start here.
```{r readinrds}
tic()
latestpull <- "2026-01-28"
wdfwtix_filename <- paste0('WDFW fish tickets 2003-2025_',latestpull)
wdfw_tix <- read_rds(paste0(out_conf_dir, wdfwtix_filename, '.rds'))
toc()

# 23.801 sec elapsed

#glimpse(wdfw_tix)

```
# Convert to crab years

A crab year is defined as week 46 of year 1 through week 45 of year 2

```{r crab_year}

wdfw_tix1 <- wdfw_tix %>%
  mutate(tdate = ymd(LANDING_DATE)) %>%
  ## create 'calendar week of landing' variable
  mutate(tweek=week(tdate)) %>%
  ## create crab year variable 
  mutate(crab_year = as.numeric(ifelse(tweek > 45, LANDING_YEAR + 1, LANDING_YEAR)))
rm(wdfw_tix)

```

Set the crab years of interest for this ESR.

```{r crab_year_ESR}

min_crab_year <- 2004
max_crab_year <- 2025
year_range <- as.numeric(min_crab_year:max_crab_year)

```

# Summarize

For the ISDERIVED column: 0 means it is not derived, 
1 means it is derived, Null means we do not know

Theresa Tsou (WDFW) 01-27-2026. "I would like to point out again that if a landing port is derived from the license database, it doesnâ€™t always mean it is an error. Most of the time, the address on license reflects their home port, the port they use most often."

```{r sum_isportderived}

wdfw_tix1$IS_PORT_DERIVED <- as.factor(wdfw_tix1$IS_PORT_DERIVED)

portderivedsum <- wdfw_tix1 %>%
  filter(crab_year >= min_crab_year) %>%
  filter(crab_year <= max_crab_year) %>%
  group_by(crab_year, IS_PORT_DERIVED) %>%
  summarise(
    num_tix = n(),
    total_landings = sum(LANDED_WEIGHT_MTONS, na.rm=TRUE), # 01-28-2026. warning: added na.rm = TRUE; implications unclear but it prevents in the total_landings column
    total_afi_revenue = sum(AFI_EXVESSEL_REVENUE, na.rm=TRUE), # 01-28-2026. warning: added na.rm = TRUE; implications unclear but it prevents in the total_afi_revenue column
    .groups = 'drop' #'drop_last'. changed 01-28-2026
  ) %>%
  
  # make sure every crab_year is represented for every level of IS_PORT_DERIVED
  complete(IS_PORT_DERIVED, crab_year = year_range, fill = list(num_tix = 0, total_landings = 0, total_afi_revenue = 0), explicit = FALSE) %>% 
  
  group_by(crab_year) %>%
  mutate(
    percent_tix = scales::percent(num_tix/sum(num_tix), accuracy = 0.1),
    percent_landings = scales::percent(total_landings/sum(total_landings), accuracy = 0.1),
    percent_revenue = scales::percent(total_afi_revenue/sum(total_afi_revenue), accuracy = 0.1)
  )

portderivedsumpercent <- portderivedsum %>%
  dplyr::select(crab_year, IS_PORT_DERIVED, percent_tix, percent_landings, percent_revenue) %>%
  pivot_wider(names_from = IS_PORT_DERIVED, values_from = c(percent_tix, percent_landings, percent_revenue)) %>%
  dplyr::select(crab_year,
          percent_tix_0,
          percent_landings_0,
          percent_revenue_0,
          percent_tix_1,
          percent_landings_1,
          percent_revenue_1,
          percent_tix_NA,
          percent_landings_NA,
          percent_revenue_NA
          )


```

# Make 3 pretty tables and combine

```{r pretty_table}

portNOTderived_out <- portderivedsumpercent %>%
  dplyr::select(
    crab_year,
    percent_tix_0,
    percent_landings_0,
    percent_revenue_0) %>%
  rename(
    Year = 'crab_year',
    `% of Landings Receipts` = percent_tix_0,
    `% of Landings` = percent_landings_0,
    `% of Revenue` = percent_revenue_0)

portderived_out <- portderivedsumpercent %>%
  dplyr::select(
    crab_year,
    percent_tix_1,
    percent_landings_1,
    percent_revenue_1) %>%
  rename(
    Year = 'crab_year',
    `% of Landings Receipts` = percent_tix_1,
    `% of Landings` = percent_landings_1,
    `% of Revenue` = percent_revenue_1)

portderivedUNKNOWN_out <- portderivedsumpercent %>%
  dplyr::select(
    crab_year,
    percent_tix_NA,
    percent_landings_NA,
    percent_revenue_NA) %>%
  rename(
    Year = 'crab_year',
    `% of Landings Receipts` = percent_tix_NA,
    `% of Landings` = percent_landings_NA,
    `% of Revenue` = percent_revenue_NA)





# knitr::kable(
#   portderivedsumprecent,
#   col.names = c(
#     'Year',
#     '% of Landings Receipts',
#     '% of Landings',
#     '% of Revenue'
#   )
# ) %>%
#   add_header_above(
#     c(""=""," " = '% of Landings Receipts', "Port Reported" = 2, " " = '% of Revenue')
#     ) #"Group 2" = 2, "Group 3" = 2))

```

## Port not derived by year: percentages of landings receipts, landings, and revenue 

```{r portNOTderived_out}

portNOTderived_out

```

## Port derived by year: percentages of landings receipts, landings, and revenue 

```{r portderived_out}

portderived_out

```

## Port unknown if derived by year: percentages of landings receipts, landings, and revenue 

```{r portderivedUNKNOWN_out}

portderivedUNKNOWN_out

```

## Write to csv

```{r write}

write_csv(portNOTderived_out,
          here::here(statdir, paste0('portNOTderived_out_FY2026_',Sys.Date(),".csv"))
          )

write_csv(portderived_out,
          here::here(statdir, paste0('portderived_out_FY2026_',Sys.Date(),".csv"))
          )

write_csv(portderivedUNKNOWN_out,
          here::here(statdir, paste0('portderivedUNKNOWN_out_FY2026_',Sys.Date(),".csv"))
          )

```


