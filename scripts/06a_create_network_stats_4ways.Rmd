---
title: "Calculate network metrics for fisheries participation networks"
author: "Jameal Samhouri, Mary Fisher"
date: "Written 8/20/2021. Last Run `r Sys.Date()`"
output: 
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '5'
  pdf_document:
    highlight: haddock
    number_sections: yes
    toc: yes
    toc_depth: '3'
geometry: margin=1in
subtitle: Troubleshooting from SSC-ES review September 2021
fontsize: 11pt
---

# Description

This document uses the same structure as the script "***06_create_networks_4ways.Rmd***" to calculate network metrics for existing network objects, which were generated for the US West Coast using a variety of approaches. 

1) vessel-level summarized by port group (n=21)
2) vessel-level summarized by state (n=3)
3) aggregate summarized by port group (n=21)
4) aggregate summarized by state (n=3).


These network graphs were made for 2004-2020, with all of the various permutations of our assumptions. These assumptions include:
A) For vessel-level networks, a minimum annual individual fisheries revenue cutoff for each vessel of `$1`, with a minimum annual total fisheries revenue cutoff for each vessel of (i) `$1` vs (ii) `$5,000`.
B) For vessel-level networks, a minimum annual total fisheries revenue cutoff for each vessel of `$5,000`, with a minimum annual individual fisheries revenue cutoff for each vessel of (i) `$1` vs (ii) `$500`.
C) For both vessel-level and aggregate networks, edges defined based on (i) connectivity vs (ii) number of vessels. For vessel-level networks, we will use a minimum annual total fisheries revenue cutoff for each vessel of `$5,000` and a minimum annual individual fisheries revenue cutoff for each vessel of `$500`.


# Setup

<br>
```{r "setup", include=FALSE}
if(!require("here")) {install.packages("here")}
library(here)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())

## start time for full script
script_start_time <- Sys.time()
```
<br>

This script requires the following packages. 
```{r packages, message=FALSE, warning=FALSE}
if(!require("tidyverse")) {install.packages("tidyverse")}
if(!require("lubridate")) {install.packages("lubridate")}
if(!require("ggplot2")) {install.packages("ggplot2")}
if(!require("igraph")) {install.packages("igraph")}
```
<br>

And calls the following functions:
```{r}
source("R/generate_participation_network.R") # this function is for vessel-level networks, summarized at the port or state scale
source("R/generate_participation_network_bulk.R") # this function is for aggregate networks, summarized at the port or state scale
source("R/color_network_nodes.R")
source("R/network_stats_functions.R")
source("R/calc_network_stats.R")
```
<br>

# User Inputs 

Select your directories. These should be relative paths, since the here() function will start from within the github repository. 
```{r}
## location of fish ticket with metiers assigned, metier key for each port group
indir = '../cciea_networks-CONFIDENTIAL/data/input'

## output directory for igraph objects
outdir_ports = 'data/networks/participation_vessel_ports'
outdir_states = 'data/networks/participation_vessel_states'
outdir_ports_agg = 'data/networks/participation_agg_ports'
outdir_states_agg = 'data/networks/participation_agg_states'

## output directory for network viz
pngdir_ports = 'data/networks/participation_vessel_ports/plots'
pngdir_states = 'data/networks/participation_vessel_states/plots'
pngdir_ports_agg = 'data/networks/participation_agg_ports/plots'
pngdir_states_agg = 'data/networks/participation_agg_ports/plots'

## output file (including directory) for stat summaries
statdir = 'results/statistics'

## directory for species group key. not confidential
processdir <- "data/input"
```
<br>

Specify file name of the species groupings lookup key that contains labels for the network graphs.
```{r get_filenames}

myfile5 <- "spgrpn2_iea_key.csv"

```
<br>


Identify the crab years, port groups, and states that you would like to produce networks for. The port groups vector should include only those port groups which are present in the single data file produced with script 00. The states vector should include only those states which are present in the agid column of the fishtix data produced with script 00. 
```{r}
## (crab) years
years <- seq(2004,2019)

## IOPAC port groups
myports <- c("Puget Sound","North WA Coast","WA Coast","Other Coastal Washington","Astoria","Tillamook","Columbia River","Newport","Coos Bay","Brookings","Crescent City","Eureka","Morro Bay","Fort Bragg","Bodega Bay","San Francisco","San Diego","Monterey","Santa Barbara","Los Angeles","Unknown Ports" )

# wa_ports <- myports[1:4]
# or_ports <- myports[5:10]
# ca_ports <- myports[11:20]

## west coast states
mystates <- c("C", "O","W")

```
<br>

Some Dungeness crab landings may be recorded prior to the official opening date of the season as a part of domoic acid testing. We remove these landings because we are interested in flows of fishers between fisheries as a result of within-season activity.
```{r}
rm_crab = TRUE
```
<br>

For confidentiality, three or more vessels must be participating in a given fishery for that fishery to be included in the networks. To avoid inclusion of rare or minimal fishing activity, a given fishery must contribute to at least 10% of a vessel's seasonal revenue to be included in the network data. 

The cutoff values can be increased if more stringent fishery inclusion criteria are preferred, and the contribution cutoff may be decreased (i.e. for summaries over shorter temporal / smaller spatial scales).
```{r}

vessel_cutoff <- 3
contr_cutoff <- 0.10

```
<br>


Set these objects according to your user inputs from Scripts 1 and 3
```{r}
## the value of `k` for the k-nearest neighbor function
k <- 1

## the reference years first run through infomap
## for the cciea network analysis this does not matter because we use a prior sp groupings
ref_years <- c(2004,2005)
```
<br>




# Calculate network metrics

For networks created 4 ways (also see https://docs.google.com/document/d/1aIT1-5g2DL1G_ru0lsewWjwo7lzi6KTjz4Gq_gT_yyI/edit#heading=h.ivbgl81113fr for definitions): 

1) vessel-level summarized by port group (n=21)
2) vessel-level summarized by state (n=3)
3) aggregate summarized by port group (n=21)
4) aggregate summarized by state (n=3).

These network graphs were made for 2004-2020, with all of the various permutations of our assumptions. These assumptions include:
A) For vessel-level networks, a minimum annual individual fisheries revenue cutoff for each vessel of `$1`, with a minimum annual total fisheries revenue cutoff for each vessel of (i) `$1` vs (ii) `$5,000`.
B) For vessel-level networks, a minimum annual total fisheries revenue cutoff for each vessel of `$5,000`, with a minimum annual individual fisheries revenue cutoff for each vessel of (i) `$1` vs (ii) `$500`.
C) For both vessel-level and aggregate networks, edges defined based on (i) connectivity vs (ii) number of vessels. For vessel-level networks, we will use a minimum annual total fisheries revenue cutoff for each vessel of `$5,000` and a minimum annual individual fisheries revenue cutoff for each vessel of `$500`.

So that is a total of 2,304 network graphs to read into this script: 4 versions of each of the vessel-level networks and 2 versions of the aggregate networks, for each of the 16 years. 

## 1) Vessel-level networks summarized by port group

### A)(i) A minimum annual total and individual fisheries revenue cutoff for each vessel of $1

We only include vessels that generate >=`$1` in total fisheries revenue each year and >=`$1` in revenue from individual fisheries.

```{r}

total_rev_cutoff <- 1
indiv_rev_cutoff <- 1
edgetype         <- "connectivity"

```
<br>

```{r}
i=1
graphs_list <- list()
for(y in years){
  for(iopac in myports){ # updated to iopac 03-10-21, was p
    
    rds_name <- ifelse(rm_crab,  paste0("igraph_", iopac, "_", y, "_totalrev", total_rev_cutoff,"_indivrev", indiv_rev_cutoff,"_", edgetype,"_rmCrab.rds"),  
                       paste0("igraph_", iopac, "_", y, "_", total_rev_cutoff,"_", indiv_rev_cutoff,"_", edgetype,".rds"))
    
    if(file.exists(here::here(outdir_ports, rds_name))){
      graphs_list[[i]]      <- readRDS(here::here(outdir_ports, rds_name))
    } else{graphs_list[[i]] <- NA}
    names(graphs_list)[i]   <- paste0(y,"_",iopac)
    
    i=i+1
  }
  cat(y, "\n")
}
```
<br>

Check to make sure all graphs were read in. Which were saved as "NA"?
```{r}
# length(graphs_list) == length(years)*length(myports)
which(is.na(graphs_list))
# names(graphs_list)
```
<br>

Calculate network metrics for all graphs.
```{r}
i=1
for(y in years){
  for(iopac in myports){
    # Calculate network-level statistics
    ## using the `net_stats` function
    if(!is.na(graphs_list[i])){
      tmp_stats <- net_stats(graphs_list[[i]], y = y, stats="network")
      tmp_stats <- tmp_stats %>% mutate(pcgroup = rep(iopac, times=dim(tmp_stats)[1]))
      if(exists("stats_1")){
        stats_1 <- bind_rows(stats_1, tmp_stats)
      } else{
        stats_1 <- tmp_stats
      }
    }
    i = i + 1
  }
}

```
<br>


Write stats out to file. 
```{r eval=TRUE}
filename <- paste0("RERUN_NetworkStats_", min(years), "_", max(years), "_", length(myports), "pcgroups_", "totalrev", total_rev_cutoff,"_indivrev", indiv_rev_cutoff,"_", edgetype, "_", ifelse(rm_crab, 'rmCrab_','_'), contr_cutoff*100, "pContribution.csv")

write.csv(stats_1,here::here(statdir, filename), row.names=FALSE)
```
<br>

```{r echo=FALSE}
ggplot(data=filter(stats_1, pcgroup %in% c("North WA Coast", "Astoria","Fort Bragg","Morro Bay")), aes(x=y, y=ed)) + 
  geom_point() + geom_line() +
  facet_grid(cols=vars(pcgroup), scales="free_y") +
  scale_x_continuous(breaks=seq(min(stats_1$y), max(stats_1$y), by=2), labels=seq(min(stats_1$y), max(stats_1$y), by=2)) +
  ylim(c(0,1)) +
  ylab("Edge Density") + xlab("Year") +
  theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
                     axis.title.x=element_text(size=13),
                     axis.title.y=element_text(size=13),
                     strip.text=element_text(size=13),
                     legend.title=element_text(size=13),legend.text=element_text(size=13),
                     panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
```
<br>

```{r echo=FALSE}
ggplot(data=filter(stats_1, pcgroup %in% c("North WA Coast", "Astoria","Fort Bragg","Morro Bay")), aes(x=y, y=nc_weighted)) + 
  geom_point() + geom_line() +
  facet_grid(cols=vars(pcgroup), scales="free_y") +
  scale_x_continuous(breaks=seq(min(stats_1$y), max(stats_1$y), by=2), labels=seq(min(stats_1$y), max(stats_1$y), by=2)) +
  ylim(c(0,1)) +
  ylab("Centralization") + xlab("Year") +
  theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
                     axis.title.x=element_text(size=13),
                     axis.title.y=element_text(size=13),
                     strip.text=element_text(size=13),
                     legend.title=element_text(size=13),legend.text=element_text(size=13),
                     panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
```
<br>



### A)(ii) and B(i) A minimum annual total fisheries revenue cutoff for each vessel of $5,000, and an individual fisheries cutoff for each vessel of $1

We only include vessels that generate `>=$5,000` in total fisheries revenue each year and `>=$1` in revenue from individual fisheries.

```{r}

total_rev_cutoff <- 5000
indiv_rev_cutoff <- 1
edgetype <- "connectivity"

```
<br>

```{r}
i=1
graphs_list <- list()
for(y in years){
  for(iopac in myports){ # updated to iopac 03-10-21, was p
    
    rds_name <- ifelse(rm_crab,  paste0("igraph_", iopac, "_", y, "_totalrev", total_rev_cutoff,"_indivrev", indiv_rev_cutoff,"_", edgetype,"_rmCrab.rds"),  
                       paste0("igraph_", iopac, "_", y, "_", total_rev_cutoff,"_", indiv_rev_cutoff,"_", edgetype,".rds"))
    
    if(file.exists(here::here(outdir_ports, rds_name))){
      graphs_list[[i]]      <- readRDS(here::here(outdir_ports, rds_name))
    } else{graphs_list[[i]] <- NA}
    names(graphs_list)[i]   <- paste0(y,"_",iopac)
    
    i=i+1
  }
  cat(y, "\n")
}
```
<br>

Check to make sure all graphs were read in. Which were saved as "NA"?
```{r}
# length(graphs_list) == length(years)*length(myports)
which(is.na(graphs_list))
# names(graphs_list)
```
<br>

Calculate network metrics for all graphs.
```{r}
i=1
for(y in years){
  for(iopac in myports){
    # Calculate network-level statistics
    ## using the `net_stats` function
    if(!is.na(graphs_list[i])){
      tmp_stats <- net_stats(graphs_list[[i]], y = y, stats="network")
      tmp_stats <- tmp_stats %>% mutate(pcgroup = rep(iopac, times=dim(tmp_stats)[1]))
      if(exists("stats_2")){
        stats_2 <- bind_rows(stats_2, tmp_stats)
      } else{
        stats_2 <- tmp_stats
      }
    }
    i = i + 1
  }
}

```
<br>


Write stats out to file.
```{r eval=TRUE}
filename <- paste0("RERUN_NetworkStats_", min(years), "_", max(years), "_", length(myports), "pcgroups_", "totalrev", total_rev_cutoff,"_indivrev", indiv_rev_cutoff,"_", edgetype, "_", ifelse(rm_crab, 'rmCrab_','_'), contr_cutoff*100, "pContribution.csv")

write.csv(stats_2,here::here(statdir, filename), row.names=FALSE)
```
<br>

```{r echo=FALSE}
ggplot(data=filter(stats_2, pcgroup %in% c("North WA Coast", "Astoria","Fort Bragg","Morro Bay")), aes(x=y, y=ed)) + 
  geom_point() + geom_line() +
  facet_grid(cols=vars(pcgroup), scales="free_y") +
  scale_x_continuous(breaks=seq(min(stats_2$y), max(stats_2$y), by=2), labels=seq(min(stats_2$y), max(stats_2$y), by=2)) +
  ylim(c(0,1)) +
  ylab("Edge Density") + xlab("Year") +
  theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
                     axis.title.x=element_text(size=13),
                     axis.title.y=element_text(size=13),
                     strip.text=element_text(size=13),
                     legend.title=element_text(size=13),legend.text=element_text(size=13),
                     panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
```
<br>

```{r echo=FALSE}
ggplot(data=filter(stats_2, pcgroup %in% c("North WA Coast", "Astoria","Fort Bragg","Morro Bay")), aes(x=y, y=nc_weighted)) + 
  geom_point() + geom_line() +
  facet_grid(cols=vars(pcgroup), scales="free_y") +
  scale_x_continuous(breaks=seq(min(stats_2$y), max(stats_2$y), by=2), labels=seq(min(stats_2$y), max(stats_2$y), by=2)) +
  ylim(c(0,1)) +
  ylab("Centralization") + xlab("Year") +
  theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
                     axis.title.x=element_text(size=13),
                     axis.title.y=element_text(size=13),
                     strip.text=element_text(size=13),
                     legend.title=element_text(size=13),legend.text=element_text(size=13),
                     panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
```
<br>



### B)(ii) and C)(i) A minimum annual total fisheries revenue cutoff for each vessel of $5,000, and a minimum annual individual fisheries revenue cutoff for each vessel of $500.

We only include vessels that generate >=`$5,000` in total fisheries revenue each year and >=`$500` in revenue from individual fisheries.

```{r}

total_rev_cutoff <- 5000
indiv_rev_cutoff <- 500
edgetype <- "connectivity"

```
<br>

```{r}
i=1
graphs_list <- list()
for(y in years){
  for(iopac in myports){ # updated to iopac 03-10-21, was p
    
    rds_name <- ifelse(rm_crab,  paste0("igraph_", iopac, "_", y, "_totalrev", total_rev_cutoff,"_indivrev", indiv_rev_cutoff,"_", edgetype,"_rmCrab.rds"),  
                       paste0("igraph_", iopac, "_", y, "_", total_rev_cutoff,"_", indiv_rev_cutoff,"_", edgetype,".rds"))
    
    if(file.exists(here::here(outdir_ports, rds_name))){
      graphs_list[[i]]      <- readRDS(here::here(outdir_ports, rds_name))
    } else{graphs_list[[i]] <- NA}
    names(graphs_list)[i]   <- paste0(y,"_",iopac)
    
    i=i+1
  }
  cat(y, "\n")
}
```
<br>

Check to make sure all graphs were read in. Which were saved as "NA"?
```{r}
# length(graphs_list) == length(years)*length(myports)
which(is.na(graphs_list))
# names(graphs_list)
```
<br>

Calculate network metrics for all graphs.
```{r}
i=1
for(y in years){
  for(iopac in myports){
    # Calculate network-level statistics
    ## using the `net_stats` function
    if(!is.na(graphs_list[i])){
      tmp_stats <- net_stats(graphs_list[[i]], y = y, stats="network")
      tmp_stats <- tmp_stats %>% mutate(pcgroup = rep(iopac, times=dim(tmp_stats)[1]))
      if(exists("stats_3")){
        stats_3 <- bind_rows(stats_3, tmp_stats)
      } else{
        stats_3 <- tmp_stats
      }
    }
    i = i + 1
  }
}

```
<br>


Write stats out to file.
```{r eval=TRUE}
filename <- paste0("RERUN_NetworkStats_", min(years), "_", max(years), "_", length(myports), "pcgroups_", "totalrev", total_rev_cutoff,"_indivrev", indiv_rev_cutoff,"_", edgetype, "_", ifelse(rm_crab, 'rmCrab_','_'), contr_cutoff*100, "pContribution.csv")

write.csv(stats_3,here::here(statdir, filename), row.names=FALSE)
```
<br>

```{r echo=FALSE}
ggplot(data=filter(stats_3, pcgroup %in% c("North WA Coast", "Astoria","Fort Bragg","Morro Bay")), aes(x=y, y=ed)) + 
  geom_point() + geom_line() +
  facet_grid(cols=vars(pcgroup), scales="free_y") +
  scale_x_continuous(breaks=seq(min(stats_3$y), max(stats_3$y), by=2), labels=seq(min(stats_3$y), max(stats_3$y), by=2)) +
  ylim(c(0,1)) +
  ylab("Edge Density") + xlab("Year") +
  theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
                     axis.title.x=element_text(size=13),
                     axis.title.y=element_text(size=13),
                     strip.text=element_text(size=13),
                     legend.title=element_text(size=13),legend.text=element_text(size=13),
                     panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
```
<br>

```{r echo=FALSE}
ggplot(data=filter(stats_3, pcgroup %in% c("North WA Coast", "Astoria","Fort Bragg","Morro Bay")), aes(x=y, y=nc_weighted)) + 
  geom_point() + geom_line() +
  facet_grid(cols=vars(pcgroup), scales="free_y") +
  scale_x_continuous(breaks=seq(min(stats_3$y), max(stats_3$y), by=2), labels=seq(min(stats_3$y), max(stats_3$y), by=2)) +
  ylim(c(0,1)) +
  ylab("Centralization") + xlab("Year") +
  theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
                     axis.title.x=element_text(size=13),
                     axis.title.y=element_text(size=13),
                     strip.text=element_text(size=13),
                     legend.title=element_text(size=13),legend.text=element_text(size=13),
                     panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
```
<br>


## 2) Vessel-level networks summarized by state

### A)(i) A minimum annual total and individual fisheries revenue cutoff for each vessel of $1

We only include vessels that generate >=`$1` in total fisheries revenue each year and >=`$1` in revenue from individual fisheries.

```{r}

total_rev_cutoff <- 1
indiv_rev_cutoff <- 1
edgetype <- "connectivity"

```
<br>

```{r}
i=1
graphs_list <- list()
for(y in years){
  for(wc_state in mystates){
    
    rds_name <- ifelse(rm_crab,  paste0("igraph_", wc_state, "_", y, "_totalrev", total_rev_cutoff,"_indivrev", indiv_rev_cutoff,"_", edgetype,"_rmCrab.rds"),  
                       paste0("igraph_", wc_state, "_", y, "_", total_rev_cutoff,"_", indiv_rev_cutoff,"_", edgetype,".rds"))
    
    if(file.exists(here::here(outdir_states, rds_name))){
      graphs_list[[i]]      <- readRDS(here::here(outdir_states, rds_name))
    } else{graphs_list[[i]] <- NA}
    names(graphs_list)[i]   <- paste0(y,"_",wc_state)
    
    i=i+1
  }
  cat(y, "\n")
}
```
<br>

Check to make sure all graphs were read in. Which were saved as "NA"?
```{r}
# length(graphs_list) == length(years)*length(mystates)
which(is.na(graphs_list))
# names(graphs_list)
```
<br>

Calculate network metrics for all graphs.
```{r}
i=1
for(y in years){
  for(wc_state in mystates){
    # Calculate network-level statistics
    ## using the `net_stats` function
    if(!is.na(graphs_list[i])){
      tmp_stats <- net_stats(graphs_list[[i]], y = y, stats="network")
      tmp_stats <- tmp_stats %>% mutate(state = rep(wc_state, times=dim(tmp_stats)[1]))
      if(exists("sstats_1")){
        sstats_1 <- bind_rows(sstats_1, tmp_stats)
      } else{
        sstats_1 <- tmp_stats
      }
    }
    i = i + 1
  }
}

```
<br>

Write stats out to file.
```{r eval=TRUE}
filename <- paste0("RERUN_NetworkStats_", min(years), "_", max(years), "_", length(mystates), "states_", "totalrev", total_rev_cutoff,"_indivrev", indiv_rev_cutoff,"_", edgetype, "_", ifelse(rm_crab, 'rmCrab_','_'), contr_cutoff*100, "pContribution.csv")

write.csv(sstats_1,here::here(statdir, filename), row.names=FALSE)
```
<br>

```{r echo=FALSE}
ggplot(data=sstats_1, aes(x=y, y=ed)) + 
  geom_point() + geom_line() +
  facet_grid(cols=vars(state), scales="free_y") +
  scale_x_continuous(breaks=seq(min(sstats_1$y), max(sstats_1$y), by=2), labels=seq(min(sstats_1$y), max(sstats_1$y), by=2)) +
  ylim(c(0,1)) +
  ylab("Edge Density") + xlab("Year") +
  theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
                     axis.title.x=element_text(size=13),
                     axis.title.y=element_text(size=13),
                     strip.text=element_text(size=13),
                     legend.title=element_text(size=13),legend.text=element_text(size=13),
                     panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
```
<br>

```{r echo=FALSE}
ggplot(data=sstats_1, aes(x=y, y=nc_weighted)) + 
  geom_point() + geom_line() +
  facet_grid(cols=vars(state), scales="free_y") +
  scale_x_continuous(breaks=seq(min(sstats_1$y), max(sstats_1$y), by=2), labels=seq(min(sstats_1$y), max(sstats_1$y), by=2)) +
  ylim(c(0,1)) +
  ylab("Network Centralization") + xlab("Year") +
  theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
                     axis.title.x=element_text(size=13),
                     axis.title.y=element_text(size=13),
                     strip.text=element_text(size=13),
                     legend.title=element_text(size=13),legend.text=element_text(size=13),
                     panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
```
<br>



#### A)(ii) and B(i) A minimum annual total fisheries revenue cutoff for each vessel of $5,000, and an individual fisheries cutoff for each vessel of $1

We only include vessels that generate `>=$5,000` in total fisheries revenue each year and `>=$1` in revenue from individual fisheries.

```{r}

total_rev_cutoff <- 5000
indiv_rev_cutoff <- 1
edgetype <- "connectivity"

```
<br>

```{r}
i=1
graphs_list <- list()
for(y in years){
  for(wc_state in mystates){
    
    rds_name <- ifelse(rm_crab,  paste0("igraph_", wc_state, "_", y, "_totalrev", total_rev_cutoff,"_indivrev", indiv_rev_cutoff,"_", edgetype,"_rmCrab.rds"),  
                       paste0("igraph_", wc_state, "_", y, "_", total_rev_cutoff,"_", indiv_rev_cutoff,"_", edgetype,".rds"))
    
    if(file.exists(here::here(outdir_states, rds_name))){
      graphs_list[[i]]      <- readRDS(here::here(outdir_states, rds_name))
    } else{graphs_list[[i]] <- NA}
    names(graphs_list)[i]   <- paste0(y,"_",wc_state)
    
    i=i+1
  }
  cat(y, "\n")
}
```
<br>

Check to make sure all graphs were read in. Which were saved as "NA"?
```{r}
# length(graphs_list) == length(years)*length(mystates)
which(is.na(graphs_list))
# names(graphs_list)
```
<br>

Calculate network metrics for all graphs.
```{r}
i=1
for(y in years){
  for(wc_state in mystates){
    # Calculate network-level statistics
    ## using the `net_stats` function
    if(!is.na(graphs_list[i])){
      tmp_stats <- net_stats(graphs_list[[i]], y = y, stats="network")
      tmp_stats <- tmp_stats %>% mutate(state = rep(wc_state, times=dim(tmp_stats)[1]))
      if(exists("sstats_2")){
        sstats_2 <- bind_rows(sstats_2, tmp_stats)
      } else{
        sstats_2 <- tmp_stats
      }
    }
    i = i + 1
  }
}

```
<br>

Write stats out to file.
```{r eval=TRUE}
filename <- paste0("RERUN_NetworkStats_", min(years), "_", max(years), "_", length(mystates), "states_", "totalrev", total_rev_cutoff,"_indivrev", indiv_rev_cutoff,"_", edgetype, "_", ifelse(rm_crab, 'rmCrab_','_'), contr_cutoff*100, "pContribution.csv")

write.csv(sstats_2,here::here(statdir, filename), row.names=FALSE)
```
<br>

```{r echo=FALSE}
ggplot(data=sstats_2, aes(x=y, y=ed)) + 
  geom_point() + geom_line() +
  facet_grid(cols=vars(state), scales="free_y") +
  scale_x_continuous(breaks=seq(min(sstats_2$y), max(sstats_2$y), by=2), labels=seq(min(sstats_2$y), max(sstats_2$y), by=2)) +
  ylim(c(0,1)) +
  ylab("Edge Density") + xlab("Year") +
  theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
                     axis.title.x=element_text(size=13),
                     axis.title.y=element_text(size=13),
                     strip.text=element_text(size=13),
                     legend.title=element_text(size=13),legend.text=element_text(size=13),
                     panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
```
<br>

```{r echo=FALSE}
ggplot(data=sstats_2, aes(x=y, y=nc_weighted)) + 
  geom_point() + geom_line() +
  facet_grid(cols=vars(state), scales="free_y") +
  scale_x_continuous(breaks=seq(min(sstats_2$y), max(sstats_2$y), by=2), labels=seq(min(sstats_2$y), max(sstats_2$y), by=2)) +
  ylim(c(0,1)) +
  ylab("Network Centralization") + xlab("Year") +
  theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
                     axis.title.x=element_text(size=13),
                     axis.title.y=element_text(size=13),
                     strip.text=element_text(size=13),
                     legend.title=element_text(size=13),legend.text=element_text(size=13),
                     panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
```
<br>



#### B)(ii) and C)(i) A minimum annual total fisheries revenue cutoff for each vessel of $5,000, and a minimum annual individual fisheries revenue cutoff for each vessel of $500

We only include vessels that generate >=`$5,000` in total fisheries revenue each year and >=`$500` in revenue from individual fisheries.

```{r}

total_rev_cutoff <- 5000
indiv_rev_cutoff <- 500
edgetype <- "connectivity"

```


```{r}
i=1
graphs_list <- list()
for(y in years){
  for(wc_state in mystates){
    
    rds_name <- ifelse(rm_crab,  paste0("igraph_", wc_state, "_", y, "_totalrev", total_rev_cutoff,"_indivrev", indiv_rev_cutoff,"_", edgetype,"_rmCrab.rds"),  
                       paste0("igraph_", wc_state, "_", y, "_", total_rev_cutoff,"_", indiv_rev_cutoff,"_", edgetype,".rds"))
    
    if(file.exists(here::here(outdir_states, rds_name))){
      graphs_list[[i]]      <- readRDS(here::here(outdir_states, rds_name))
    } else{graphs_list[[i]] <- NA}
    names(graphs_list)[i]   <- paste0(y,"_",wc_state)
    
    i=i+1
  }
  cat(y, "\n")
}
```
<br>

Check to make sure all graphs were read in. Which were saved as "NA"?
```{r}
# length(graphs_list) == length(years)*length(mystates)
which(is.na(graphs_list))
# names(graphs_list)
```
<br>

Calculate network metrics for all graphs.
```{r}
i=1
for(y in years){
  for(wc_state in mystates){
    # Calculate network-level statistics
    ## using the `net_stats` function
    if(!is.na(graphs_list[i])){
      tmp_stats <- net_stats(graphs_list[[i]], y = y, stats="network")
      tmp_stats <- tmp_stats %>% mutate(state = rep(wc_state, times=dim(tmp_stats)[1]))
      if(exists("sstats_3")){
        sstats_3 <- bind_rows(sstats_3, tmp_stats)
      } else{
        sstats_3 <- tmp_stats
      }
    }
    i = i + 1
  }
}

```
<br>

Write stats out to file.
```{r eval=TRUE}
filename <- paste0("RERUN_NetworkStats_", min(years), "_", max(years), "_", length(mystates), "states_", "totalrev", total_rev_cutoff,"_indivrev", indiv_rev_cutoff,"_", edgetype, "_", ifelse(rm_crab, 'rmCrab_','_'), contr_cutoff*100, "pContribution.csv")

write.csv(sstats_3,here::here(statdir, filename), row.names=FALSE)
```
<br>

```{r echo=FALSE}
ggplot(data=sstats_3, aes(x=y, y=ed)) + 
  geom_point() + geom_line() +
  facet_grid(cols=vars(state), scales="free_y") +
  scale_x_continuous(breaks=seq(min(sstats_3$y), max(sstats_3$y), by=2), labels=seq(min(sstats_3$y), max(sstats_3$y), by=2)) +
  ylim(c(0,1)) +
  ylab("Edge Density") + xlab("Year") +
  theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
                     axis.title.x=element_text(size=13),
                     axis.title.y=element_text(size=13),
                     strip.text=element_text(size=13),
                     legend.title=element_text(size=13),legend.text=element_text(size=13),
                     panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
```
<br> 

```{r echo=FALSE}
ggplot(data=sstats_3, aes(x=y, y=nc_weighted)) + 
  geom_point() + geom_line() +
  facet_grid(cols=vars(state), scales="free_y") +
  scale_x_continuous(breaks=seq(min(sstats_3$y), max(sstats_3$y), by=2), labels=seq(min(sstats_3$y), max(sstats_3$y), by=2)) +
  ylim(c(0,1)) +
  ylab("Network Centralization") + xlab("Year") +
  theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
                     axis.title.x=element_text(size=13),
                     axis.title.y=element_text(size=13),
                     strip.text=element_text(size=13),
                     legend.title=element_text(size=13),legend.text=element_text(size=13),
                     panel.grid.major=element_blank(),
                     panel.grid.minor=element_blank())
```
<br>



# conclusion

The network stats function is, when applied to existing graph objects using the same structure as the original script "**06_create_networks_4ways.Rmd**" (1) producing the correct edge densities (not all 1); and (2) not generating missing data for network centralization; for the vessel-level connectivity networks.


